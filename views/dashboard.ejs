<!DOCTYPE html>
<html>
	<head>
		<% include shims/head.ejs %>
	</head>
	<body>
		<% include shims/header.ejs %>
		<main>
			<div class="container">
				<div class="row">
					<div class="col s12">
						<br>
						<ul id="tabs-swipe-demo" class="tabs">
							<li class="tab col s3"><a class="active" href="#test-swipe-1">detect</a></li>
							<li class="tab col s3"><a href="#test-swipe-2">generate</a></li>
							<li class="tab col s3"><a href="#dataset">dataset</a></li>
						</ul>
						<div id="test-swipe-1" class="my-container z-depth-2 col s12">
							<br>
							<div class="row">
								<div class="col s12 l6 cam">
									<div id="my_camera" style="width:100%; height:240px;"></div>
					    			<p class="center"><a href="javascript:void(take_snapshot())" class="waves-effect waves-light btn red col s12"><i class="material-icons">camera_alt</i></a></p>
								</div>
								<div class="col s12 l6 cam">
									<div id="my_result" style="width:100%; height:240px;">No image loaded</div>	
					    			<p class="center"><a href="javascript:void(send_image())" class="waves-effect waves-light btn blue col s12">Check</a></p>
								</div>
							</div>
							<div class="row">
								<div class="col s12">
							      <ul id="possible-matches" class="collection">
							      </ul>
								</div>
							</div>	
						</div>
						<div id="test-swipe-2" class="my-container z-depth-2 col s12">
							<div class="col s2"></div>
							<div class="col s8">
								<p class="flow-text">Please enter you dataset in the form of a compressed zip file</p>
								<form encType="multipart/form-data" action="#" method="POST" class="file-field input-field submit-form">
									
									<div class="row">
							       		<div class="btn red col s6">
											<span>File</span>
											<input name="file" id="file" type="file">
										</div>
										<div class="file-path-wrapper col s6">
											<input class="file-path validate" type="text">
										</div>
							      	</div>
									
									<input id="dataset_type" type="text" hidden="true" name="type" value="102">
									
									<div class="row">
							       		<a href="javascript:void(send_dataset())" class="waves-effect waves-light btn blue col s12">Upload</a>
							      	</div>
									
								</form>
							</div>
						</div>

						<div id="dataset" class="my-container z-depth-2 col s12">
							<div class="row">
								<div class="col s12">
									<h4 class="center">Trained Faces</h4>
								</div>
							</div>
							<div class="row">
								<div class="col s12">
									<ul class="collection" id="dataset_collection">
								    </ul>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
		<% include shims/footer.ejs %>
		<!--JavaScript at end of body for optimized loading-->
		<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
		<script type="text/javascript" src="js/webcam.min.js"></script>
	    <script language="JavaScript">
	        Webcam.attach( '#my_camera' );
	        Webcam.set({
		        width: 320,
		        height: 240,
		        dest_width: 640,
		        dest_height: 480,
		        image_format: 'jpeg',
		        jpeg_quality: 100,
		        force_flash: false,
		        flip_horiz: true,
		        fps: 45
		    });
	        function take_snapshot() {
	            Webcam.snap( function(data_uri) {
	            	raw_image_data = data_uri.replace(/^data\:image\/\w+\;base64\,/, '');
	                document.getElementById('my_result').innerHTML = '<img width="320" height="240" src="'+data_uri+'"/>';
	            } );
	        }
	        function send_image() {
	        	$("#possible-matches").html(" ");
	        	$.ajax({
	                url: "/request",
	                type: "post",
	                data: { image: raw_image_data, type: 101, person_id: $("#person_id").val() },
	                success: function(result) {
	                	console.log(result);
	                	if(!result.error) {

	                		for(i=0;i<result.data.length;i++) {

	                			if(i == 3 ) {
	                				break;
	                			}

	                			var item = `
	                				<a href="">
						        	<li class="collection-item"><div>${result.data[i].className} - ${result.data[i].distance}<a href="#!" class="secondary-content"><i class="material-icons">send</i></a></div></li>
	                				</a>
	                			`;

	                			$("#possible-matches").append(item);
	                		}

	                	} else {
	                		M.toast({html: "error"});
	                	}
	                	
	                }
	            });
	        }
	        
	        function request_collection() {
	        	$.ajax({
				    url: "/get-database-resoruce",
				    type: "post",
				    success: function(result) {
				        if(!result.error) {
				        	$("#dataset_collection").html("");
				        	for( i=0; i<result.data.length; i++ ) {
				        		var collection = `
				        		<li class="collection-item avatar">
							      <span class="title">${ result.data[i].className }</span>
							      <p>
							      	trained ${ result.data[i].numFaces } faces
							      </p>
							    </li>
				        		`;
				        		$("#dataset_collection").append(collection);
				           		// M.toast({html: result.data[i].className+""}); 
				        	}
				        } else {
				            M.toast({html: "error"});
				        }
				    }
				});
	        }

	        function open_sidebar() {
	        	var instance = M.Sidenav.getInstance($("#mobile-demo"));
	        	instance.open();
	        }

	        function send_dataset() {
	        	// $('form').submit();
	        	
	        	var formData = new FormData();
				
				// HTML file input, chosen by user
				formData.append("userfile", $('#file')[0].files[0]);
				
				var request = new XMLHttpRequest();
				
				request.onreadystatechange = function() {
				    if (this.readyState == 4 && this.status == 200) {
				    	var current = this.responseText;
			    		M.toast({html: current});
			    		reload_dataset();
				    	console.log('response: ' + this.responseText);
				    }
			  	};
			  	request.timeout = 1000*60*30;
				request.open("POST", "/handleDataset");
				request.send(formData);
	        }
	        function reload_dataset() {
	        	$.ajax({
	                url: "/reload-dataset",
	                type: "post",
	                success: function(result) {
	                	console.log(result);
	                	if(result.error) {
	                		M.toast({html: 'no dataset found'});
	                	} else {
	                		M.toast({html: 'dataset loaded successfully'});
	                		request_collection();
	                	}
	                }
	            });
	        }
	    </script> 
	    <script type="text/javascript">
	    	$(document).ready(function(){
	    		<% if( loaded ) { %>
	    			M.toast({html: 'dataset loaded successfully'})
	    		<% } else { %>
	    			M.toast({html: 'no dataset found'})
	    		<% } %>
	    		$('.tabs').tabs();
	    		$('.sidenav').sidenav();
	    		reload_dataset();
	    	});
	    </script>

	      <script>
		    window.onload = function() {
		      var video = document.getElementById('video');
		      var canvas = document.getElementById('canvas');
		      var context = canvas.getContext('2d');
		      var request = false;
		      var tracker = new tracking.ObjectTracker('face');
		      tracker.setInitialScale(4);
		      tracker.setStepSize(2);
		      tracker.setEdgesDensity(0.1);


		      tracking.track('#video', tracker, { camera: true });

		      tracker.on('track', function(event) {
		        context.clearRect(0, 0, canvas.width, canvas.height);
		   
		        if(!request) {
		          var frame = captureVideoFrame('video', 'png');
		          var raw_image_data = frame.dataUri.replace(/^data\:image\/\w+\;base64\,/, '');
		          console.log(raw_image_data);
		          request = true;
		          $.ajax({
		              url: "/request",
		              type: "post",
		              data: { image: raw_image_data, type: 101 },
		              success: function(result) {
		                if(!result.error) {
		                  M.toast({html: result.data+""});
		                } else {
		                  M.toast({html: "error"});
		                }
		                request = false;
		              },
		              failure: function(result) {
		                request = false;
		              }
		          });
		        }
		        event.data.forEach(function(rect) {
		          context.strokeStyle = '#a64ceb';
		          context.strokeRect(rect.x, rect.y, rect.width, rect.height);
		          context.font = '11px Helvetica';
		          context.fillStyle = "#fff";
		        });
		      });
		    };
		  </script>
   	</body>
</html>